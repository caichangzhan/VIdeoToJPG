<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>FramePicker Â· 4:3 è§†é¢‘æˆªå›¾å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

  <!-- Cropper.jsï¼šè£å‰ªï¼ˆä¸¥æ ¼ 4:3ï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>

  <!-- JSZipï¼šå‰ç«¯æ‰“åŒ… ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --accent: #38bdf8;
      --accent-green: #22c55e;
      --accent-red: #f97373;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-mute: #6b7280;
      --border-subtle: rgba(148,163,184,0.4);
      --radius-xl: 18px;
      --radius-lg: 12px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      display: flex;
      justify-content: center;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
      color: var(--text-main);
    }

    .app {
      width: 100%;
      max-width: 1120px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    header {
      padding: 10px 14px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
      border: 1px solid rgba(148,163,184,0.45);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      box-shadow: 0 12px 35px rgba(15,23,42,0.7);
      backdrop-filter: blur(14px);
    }

    .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-main {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: radial-gradient(circle at top, rgba(148,163,184,0.25), rgba(15,23,42,0.95));
    }

    .title-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: var(--text-sub);
    }
    .chip {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 14px;
    }
    @media (max-width: 880px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
      header { flex-direction: column; align-items: flex-start; }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.98), #020617);
      border-radius: var(--radius-xl);
      padding: 14px 16px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 18px 50px rgba(15,23,42,0.9);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .step {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .step-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .card-title { font-size: 15px; font-weight: 600; }
    .card-sub { font-size: 12px; color: var(--text-sub); }

    .card-meta {
      font-size: 11px;
      color: var(--text-mute);
      text-align: right;
    }

    .file-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    input[type="file"] {
      font-size: 13px;
      color: var(--text-main);
    }
    input[type="file"]::file-selector-button {
      border:none;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
      border:1px solid rgba(148,163,184,0.7);
      margin-right: 10px;
    }

    #videoMeta {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    #videoPlayer {
      display:none; /* éšè— videoï¼Œä»…ä½œä¸ºå¸§æº */
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-top: 8px;
    }

    .col-preview { flex: 0 0 280px; max-width: 360px; min-width: 240px; }
    .col-controls { flex: 1; min-width: 230px; }

    .label {
      font-size: 12px;
      color: var(--text-sub);
      margin: 4px 0;
    }

    #previewWrap {
      position: relative;
      width: 100%;
      max-width: 380px;
      overflow: hidden;
      border-radius: var(--radius-lg);
      background:#020617;
      border:1px solid rgba(148,163,184,0.5);
      touch-action:none; /* é¿å…åœ¨å›¾ä¸Šæ»šåŠ¨é¡µé¢æ—¶è§¦å‘é»˜è®¤è¡Œä¸º */
      box-shadow: 0 12px 32px rgba(15,23,42,0.9);
    }

    #framePreview {
      width: 100%;
      display: none;
      user-select: none;
      -webkit-user-drag: none;
      touch-action:none;
    }

    .cropper-container {
      font-family: inherit;
      touch-action:none;
    }

    .zoom-slider {
      width: 100%;
      accent-color: #38bdf8;
    }
    .zoom-slider[type="range"] {
      -webkit-appearance:none;
      appearance:none;
      height:4px;
      border-radius:999px;
      background: rgba(15,23,42,0.9);
      outline:none;
    }
    .zoom-slider[type="range"]::-webkit-slider-thumb {
      -webkit-appearance:none;
      appearance:none;
      width:15px;
      height:15px;
      border-radius:999px;
      background: var(--accent);
      box-shadow:0 0 0 2px rgba(15,23,42,0.9);
      cursor:pointer;
    }
    .zoom-slider[type="range"]::-moz-range-thumb {
      width:15px;
      height:15px;
      border-radius:999px;
      background: var(--accent);
      cursor:pointer;
    }

    .btn {
      padding: 7px 14px;
      border-radius: var(--radius-pill);
      border: none;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s;
      white-space: nowrap;
    }
    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
      transform:none;
      box-shadow:none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #2563eb);
      color:#f9fafb;
      border:1px solid rgba(191,219,254,0.9);
      box-shadow:0 12px 28px rgba(37,99,235,0.55);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: rgba(15,23,42,0.98);
      color: var(--text-sub);
      border:1px solid rgba(148,163,184,0.7);
    }
    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-1px);
    }
    .btn-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color:#f9fafb;
      border:1px solid rgba(187,247,208,0.9);
      box-shadow:0 12px 30px rgba(34,197,94,0.55);
    }
    .btn-success:hover:not(:disabled) {
      transform: translateY(-1px);
    }

    /* æ—¶é—´è½´ */

    #trimContainer {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 62px;
      margin-top: 6px;
      overflow: hidden;
      border-radius: 12px;
      background: radial-gradient(circle at top, #1e293b, #020617);
      border:1px solid rgba(30,64,175,0.7);
      box-shadow: 0 10px 30px rgba(15,23,42,0.8);
    }
    #timeline {
      height: 100%;
      display: flex;
    }
    #timeline img {
      height: 100%;
      width: auto;
      flex-shrink: 0;
      object-fit: cover;
      filter: saturate(1.05) contrast(1.05);
    }
    #trimOverlay {
      position: absolute;
      inset: 0;
      pointer-events:none;
    }
    .handle {
      position: absolute;
      top: 0;
      width: 14px;
      height: 100%;
      background: rgba(15,23,42,0.1);
      border: 2px solid #f9fafb;
      border-radius: 10px;
      cursor: ew-resize;
      box-shadow:0 0 0 1px rgba(15,23,42,0.9), 0 0 8px rgba(15,23,42,0.9);
      pointer-events:auto;
      z-index:2;
    }
    .handle::before {
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:1px;
      height:22px;
      transform:translate(-50%,-50%);
      border-radius:999px;
      background:linear-gradient(to bottom, rgba(15,23,42,0.15), rgba(15,23,42,0.9), rgba(15,23,42,0.15));
    }

    #leftHandle { left: 0; }
    #rightHandle { right: 0; }

    .shade {
      position: absolute;
      top: 0;
      height: 100%;
      background: rgba(15,23,42,0.78);
      pointer-events: none;
      z-index:1;
    }
    #shadeLeft  { left: 0; width: 0; }
    #shadeRight { right: 0; width: 0; }

    #windowDragArea {
      position:absolute;
      top:0;
      height:100%;
      cursor:grab;
      z-index:1;
      pointer-events:auto;
    }

    .meta-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
      font-size:11px;
      color:var(--text-sub);
    }
    .pill {
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.65);
      background:rgba(15,23,42,0.95);
    }

    .status-bar {
      margin-top:8px;
      padding:6px 9px;
      border-radius: var(--radius-lg);
      background:rgba(15,23,42,0.97);
      border:1px solid rgba(148,163,184,0.5);
      font-size:11px;
      color:var(--text-sub);
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .status-line {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .status-dot {
      width:7px;
      height:7px;
      border-radius:999px;
      background:#6b7280;
    }
    .status-dot.working {
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(56,189,248,0.25);
    }
    .status-dot.error {
      background:var(--accent-red);
      box-shadow:0 0 0 4px rgba(248,113,113,0.25);
    }
    .status-main { color:var(--text-main); }

    .progress-wrap {
      width:100%;
      height:4px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      overflow:hidden;
    }
    .progress-bar {
      width:0%;
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg, #38bdf8, #22c55e);
      transition:width 0.12s ease-out;
    }

    /* ç»“æœåˆ—è¡¨ */

    #framesStrip {
      margin-top:10px;
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:4px;
    }
    #framesStrip::-webkit-scrollbar {
      height:6px;
    }
    #framesStrip::-webkit-scrollbar-track {
      background:rgba(15,23,42,0.9);
      border-radius:999px;
    }
    #framesStrip::-webkit-scrollbar-thumb {
      background:linear-gradient(90deg,#38bdf8,#22c55e);
      border-radius:999px;
    }

    .thumb {
      flex:0 0 auto;
      width:160px;
      background:radial-gradient(circle at top, #020617, #020617);
      border-radius:14px;
      padding:5px;
      border:1px solid rgba(30,64,175,0.8);
      box-shadow:0 12px 30px rgba(15,23,42,0.95);
      font-size:11px;
      color:var(--text-sub);
    }
    .thumb img {
      width:100%;
      border-radius:10px;
      display:block;
    }
    .thumb-meta {
      margin-top:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .thumb-tag {
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.95);
    }
    .thumb-time {
      font-size:10px;
      color:var(--text-mute);
    }

    @media (max-width: 640px) {
      .card { padding:12px; }
      .card-header { flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="title">
      <div class="title-main">
        FramePicker
        <span class="badge">4:3 Video Frame Cutter Â· Pure Frontend</span>
      </div>
      <div class="title-sub">
        ä¸Šä¼ è§†é¢‘ â†’ æ‹–åŠ¨è£å‰ªæ¡† + æ»‘æ¡æ”¾å¤§ â†’ é€‰æ‹© 0â€“8 ç§’æ—¶é—´æ®µ â†’ æµè§ˆå™¨æœ¬åœ°é€å¸§åˆ‡å›¾ â†’ é¢„è§ˆ & ZIP ä¸‹è½½ã€‚
      </div>
    </div>
    <div class="chips">
      <span class="chip">ä¸¥æ ¼ 4:3 è¾“å‡º</span>
      <span class="chip">è£å‰ªæ¡†å¯æ‹–åŠ¨ + æ»‘æ¡ç¼©æ”¾</span>
      <span class="chip">å…¨ç¨‹æœ¬åœ°ï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨</span>
    </div>
  </header>

  <main class="grid">
    <!-- å·¦ï¼šä¸Šä¼  + è£å‰ª + æ—¶é—´è½´ -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="step"><span class="step-dot">1</span> SELECT Â· CROP Â· TRIM</div>
          <div class="card-title">é€‰æ‹©è§†é¢‘ï¼Œè®¾å®š 4:3 åŒºåŸŸå’Œæ—¶é—´åŒºé—´</div>
          <div class="card-sub">æ”¯æŒç«–å±/æ¨ªå±è§†é¢‘ï¼Œè£å‰ªæ¡†å§‹ç»ˆä¿æŒ 4:3ï¼Œæ»‘æ¡æ§åˆ¶æ”¾å¤§ã€‚</div>
        </div>
        <div class="card-meta">
          å»ºè®®ï¼šç«–å±ç´ ææ›´å‹å¥½<br/>
          å•æ®µæ—¶é—´ä¸è¶…è¿‡ 8 ç§’
        </div>
      </div>

      <div class="file-row">
        <input id="videoInput" type="file" accept="video/*">
        <button id="resetBtn" class="btn btn-secondary" style="font-size:12px;padding-inline:10px;">é‡ç½®</button>
      </div>
      <div id="videoMeta"></div>

      <!-- éšè— videoï¼Œåªä½œä¸ºå¸§æº -->
      <video id="videoPlayer" playsinline webkit-playsinline muted></video>

      <div class="row">
        <div class="col-preview">
          <div class="label">å‚è€ƒå¸§é¢„è§ˆ & 4:3 è£å‰ªï¼ˆæ‹–åŠ¨ + ä¸‹æ–¹ç¼©æ”¾ï¼‰</div>
          <div id="previewWrap">
            <img id="framePreview" alt="å‚è€ƒå¸§"/>
          </div>

          <div class="label" style="margin-top:6px;">ç¼©æ”¾ï¼š</div>
          <input
            id="zoomSlider"
            class="zoom-slider"
            type="range"
            min="0.6"
            max="3"
            step="0.1"
            value="1"
          >
        </div>

        <div class="col-controls">
          <div class="label">æ­¥éª¤ A Â· ç”Ÿæˆå‚è€ƒå¸§ & æ—¶é—´è½´</div>
          <button id="initBtn" class="btn btn-primary" disabled>âš™ï¸ ç”Ÿæˆå‚è€ƒå¸§ & æ—¶é—´è½´</button>
          <div style="font-size:11px;color:var(--text-mute);margin-top:2px;">
            é€‰å®Œè§†é¢‘åï¼Œç›´æ¥ç‚¹å‡»å³å¯ã€‚å·¥å…·ä¼šå–ä¸­é—´ä¸€å¸§ä½œä¸ºé¢„è§ˆï¼Œå¹¶ç”Ÿæˆæ•´æ®µæ—¶é—´è½´ç¼©ç•¥å›¾ã€‚
          </div>

          <div class="label" style="margin-top:10px;">æ­¥éª¤ B Â· é€‰æ‹©æ—¶é—´åŒºé—´ï¼ˆæœ€é•¿ 8 ç§’ï¼‰</div>
          <div id="trimContainer">
            <div id="timeline"></div>
            <div id="trimOverlay">
              <div id="shadeLeft" class="shade"></div>
              <div id="shadeRight" class="shade"></div>
              <div id="leftHandle" class="handle"></div>
              <div id="rightHandle" class="handle"></div>
              <div id="windowDragArea"></div>
            </div>
          </div>

          <div class="meta-row">
            <span class="pill">
              åŒºé—´ï¼š
              <span id="trimStart">0.0</span>s â€“ <span id="trimEnd">0.0</span>s
            </span>
            <span class="pill">
              å¸§ç‡ï¼š
              <input id="fpsInput" type="number" value="10" min="1" max="30"
                     style="width:52px;padding:2px 6px;border-radius:999px;border:1px solid rgba(148,163,184,0.7);background:rgba(15,23,42,0.95);color:var(--text-main);font-size:11px;">
              fps
            </span>
          </div>

          <div class="meta-row">
            <span>æç¤ºï¼šæ‹–åŠ¨é¢„è§ˆå›¾ç§»åŠ¨è£å‰ªæ¡†ï¼Œç”¨ç¼©æ”¾æ»‘æ¡è°ƒæ•´æ„å›¾ã€‚é¿å…åŒæŒ‡æåˆé€ æˆè¯¯è§¦æ”¾å¤§ã€‚</span>
          </div>

          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button id="confirmBtn" class="btn btn-primary" disabled>ğŸš€ å¼€å§‹åˆ‡å¸§ï¼ˆæœ¬åœ°ï¼‰</button>
            <button id="downloadZipBtn" class="btn btn-success" disabled>ğŸ“¦ æ‰“åŒ…ä¸‹è½½å…¨éƒ¨å›¾ç‰‡</button>
          </div>

          <div class="status-bar">
            <div class="status-line">
              <div id="statusDot" class="status-dot"></div>
              <div>
                <span id="statusMain" class="status-main">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ã€‚</span>
                <span id="statusSub"></span>
              </div>
            </div>
            <div class="progress-wrap">
              <div id="progressBar" class="progress-bar"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- å³ï¼šç»“æœ -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="step"><span class="step-dot">2</span> REVIEW Â· EXPORT</div>
          <div class="card-title">é¢„è§ˆåˆ‡å‡ºçš„ 4:3 å›¾ç‰‡ & ä¸‹è½½ ZIP</div>
          <div class="card-sub">æˆªå›¾æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼Œå¯æ¨ªå‘æ»‘åŠ¨æµè§ˆã€‚</div>
        </div>
        <div class="card-meta">
          æˆªå›¾å°ºå¯¸åŸºäºè£å‰ªåŒºåŸŸ<br/>
          ä¸¥æ ¼ 4:3ï¼Œæ— é»‘è¾¹
        </div>
      </div>

      <div style="font-size:12px;color:var(--text-mute);">
        å¦‚æœå‘ç°æ„å›¾ä¸æ»¡æ„ï¼Œå¯ä»¥å›åˆ°å·¦ä¾§è°ƒæ•´è£å‰ªæ¡†æˆ–æ—¶é—´åŒºé—´ï¼Œç„¶åé‡æ–°ç‚¹å‡»ã€Œå¼€å§‹åˆ‡å¸§ã€ã€‚
      </div>

      <div id="framesStrip"></div>
    </section>
  </main>
</div>

<script>
  const videoInput   = document.getElementById('videoInput');
  const videoPlayer  = document.getElementById('videoPlayer');
  const initBtn      = document.getElementById('initBtn');
  const resetBtn     = document.getElementById('resetBtn');
  const framePreview = document.getElementById('framePreview');
  const zoomSlider   = document.getElementById('zoomSlider');
  const fpsInput     = document.getElementById('fpsInput');
  const confirmBtn   = document.getElementById('confirmBtn');
  const downloadZipBtn = document.getElementById('downloadZipBtn');
  const statusDot    = document.getElementById('statusDot');
  const statusMain   = document.getElementById('statusMain');
  const statusSub    = document.getElementById('statusSub');
  const progressBar  = document.getElementById('progressBar');
  const videoMeta    = document.getElementById('videoMeta');
  const framesStrip  = document.getElementById('framesStrip');

  const trimContainer = document.getElementById('trimContainer');
  const timeline      = document.getElementById('timeline');
  const leftHandle    = document.getElementById('leftHandle');
  const rightHandle   = document.getElementById('rightHandle');
  const shadeLeft     = document.getElementById('shadeLeft');
  const shadeRight    = document.getElementById('shadeRight');
  const windowDrag    = document.getElementById('windowDragArea');
  const trimStartEl   = document.getElementById('trimStart');
  const trimEndEl     = document.getElementById('trimEnd');

  let cropper = null;
  let selectedFile = null;
  let videoUrl = null;

  let duration = 0;
  let trimStart = 0;
  let trimEnd = 0;
  let timelineWidth = 0;

  const MAX_WINDOW = 8;
  const MIN_WINDOW = 0.5;

  let currentFrames = [];
  let videoW = 0;
  let videoH = 0;
  let currentZoom = 1;

  const isIOS = /iP(hone|od|ad)/.test(navigator.platform)
    || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

  function setStatus({ main, sub = '', state = 'idle', progress = 0 }) {
    statusMain.textContent = main;
    statusSub.textContent = sub ? ' ' + sub : '';
    progressBar.style.width = `${Math.max(0, Math.min(100, progress))}%`;

    statusDot.className = 'status-dot';
    if (state === 'working') {
      statusDot.classList.add('working');
    } else if (state === 'error') {
      statusDot.classList.add('error');
    }
  }

  function resetAll() {
    selectedFile = null;
    videoW = 0;
    videoH = 0;
    currentZoom = 1;

    videoInput.value = '';
    zoomSlider.value = '1';

    confirmBtn.disabled = true;
    downloadZipBtn.disabled = true;
    initBtn.disabled = true;

    framesStrip.innerHTML = '';
    timeline.innerHTML = '';
    currentFrames = [];
    videoMeta.textContent = '';
    framePreview.style.display = 'none';
    progressBar.style.width = '0%';
    trimStartEl.textContent = '0.0';
    trimEndEl.textContent = '0.0';
    trimStart = 0;
    trimEnd = 0;
    timelineWidth = 0;

    if (cropper) { cropper.destroy(); cropper = null; }

    if (videoUrl) {
      URL.revokeObjectURL(videoUrl);
      videoUrl = null;
    }
    videoPlayer.src = '';

    setStatus({
      main: 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ã€‚',
      sub: 'æ”¯æŒæ‰‹æœºç›¸å†Œè§†é¢‘ï¼Œå…¨ç¨‹æœ¬åœ°å¤„ç†ã€‚',
      state: 'idle',
      progress: 0
    });
  }

  resetBtn.addEventListener('click', resetAll);

  async function unlockVideo() {
    if (!isIOS) return;
    try {
      await videoPlayer.play();
      videoPlayer.pause();
    } catch (e) {
      console.log('unlock error', e);
    }
  }

  videoInput.addEventListener('change', () => {
    const file = videoInput.files && videoInput.files[0];
    if (!file) {
      resetAll();
      return;
    }

    selectedFile = file;
    initBtn.disabled = false;
    confirmBtn.disabled = true;
    downloadZipBtn.disabled = true;
    framesStrip.innerHTML = '';
    timeline.innerHTML = '';
    currentFrames = [];
    progressBar.style.width = '5%';
    zoomSlider.value = '1';
    currentZoom = 1;

    if (cropper) { cropper.destroy(); cropper = null; framePreview.style.display = 'none'; }

    if (videoUrl) URL.revokeObjectURL(videoUrl);
    videoUrl = URL.createObjectURL(file);
    videoPlayer.src = videoUrl;

    videoPlayer.onloadedmetadata = () => {
      duration = videoPlayer.duration;
      videoW = videoPlayer.videoWidth;
      videoH = videoPlayer.videoHeight;
      videoMeta.textContent = `æ—¶é•¿ï¼š${duration.toFixed(1)} ç§’ Â· åˆ†è¾¨ç‡ï¼š${videoW} Ã— ${videoH}`;
      setStatus({
        main: 'å·²é€‰æ‹©è§†é¢‘æ–‡ä»¶ã€‚',
        sub: 'ç‚¹å‡»ã€Œç”Ÿæˆå‚è€ƒå¸§ & æ—¶é—´è½´ã€ç»§ç»­ã€‚',
        state: 'idle',
        progress: 10
      });
    };
  });

  initBtn.addEventListener('click', async () => {
    if (!selectedFile) {
      alert('è¯·å…ˆé€‰æ‹©è§†é¢‘');
      return;
    }
    initBtn.disabled = true;
    confirmBtn.disabled = true;
    downloadZipBtn.disabled = true;

    setStatus({
      main: 'æ­£åœ¨ç”Ÿæˆå‚è€ƒå¸§ & æ—¶é—´è½´â€¦',
      sub: 'æ ¹æ®è§†é¢‘å¤§å°å¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚',
      state: 'working',
      progress: 25
    });

    try {
      await unlockVideo();
      await setupPreviewFrame();
      setStatus({
        main: 'å‚è€ƒå¸§å·²ç”Ÿæˆï¼Œæ­£åœ¨æ„å»ºæ—¶é—´è½´ç¼©ç•¥å›¾â€¦',
        state: 'working',
        progress: 40
      });
      await initTimelineFromVideo();

      confirmBtn.disabled = false;
      setStatus({
        main: 'å‡†å¤‡å°±ç»ªã€‚',
        sub: 'ç°åœ¨å¯ä»¥è°ƒæ•´è£å‰ªæ¡†å’Œæ—¶é—´åŒºé—´ï¼Œç„¶åå¼€å§‹åˆ‡å¸§ã€‚',
        state: 'idle',
        progress: 55
      });
    } catch (e) {
      console.error(e);
      setStatus({
        main: 'ç”Ÿæˆå‚è€ƒå¸§å¤±è´¥ã€‚',
        sub: e.message || '',
        state: 'error',
        progress: 0
      });
      initBtn.disabled = false;
    }
  });

  async function setupPreviewFrame() {
    const captureTime = duration / 2;
    await seekVideo(captureTime);

    const canvas = document.createElement('canvas');
    canvas.width = videoW;
    canvas.height = videoH;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);

    framePreview.src = canvas.toDataURL('image/jpeg', 0.9);
    framePreview.style.display = 'block';

    if (cropper) {
      cropper.destroy();
      cropper = null;
    }

    cropper = new Cropper(framePreview, {
      aspectRatio: 4 / 3,
      viewMode: 1,
      autoCropArea: 0.9,
      dragMode: 'move',
      background: false,
      guides: false,
      center: true,
      highlight: false,
      movable: true,
      zoomable: true,       // ä¿ç•™ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç”¨ä»£ç  zoomTo
      zoomOnTouch: false,   // â— å…³é—­åŒæŒ‡ç¼©æ”¾ï¼Œé¿å…æ»‘é¡µé¢ä¹±æ”¾å¤§
      zoomOnWheel: false,
      scalable: false,
      rotatable: false,
      responsive: true,
      toggleDragModeOnDblclick: false
    });

    // åˆå§‹åŒ–ç¼©æ”¾æ»‘æ¡
    currentZoom = 1;
    zoomSlider.value = '1';
  }

  function seekVideo(time) {
    return new Promise(resolve => {
      const handler = () => {
        videoPlayer.removeEventListener('seeked', handler);
        resolve();
      };
      videoPlayer.addEventListener('seeked', handler);
      videoPlayer.currentTime = time;
    });
  }

  // ç¼©æ”¾æ»‘æ¡æ§åˆ¶è£å‰ªåŒºåŸŸ
  zoomSlider.addEventListener('input', () => {
    if (!cropper) return;
    const z = parseFloat(zoomSlider.value) || 1;
    currentZoom = z;
    cropper.zoomTo(z);
  });

  async function initTimelineFromVideo() {
    const thumbs = [];
    const framesCount = Math.min(16, Math.max(6, Math.round(duration * 1.5)));

    for (let i = 0; i < framesCount; i++) {
      const t = duration * (i + 0.5) / framesCount;
      await seekVideo(t);

      const cnv = document.createElement('canvas');
      cnv.width = 60;
      cnv.height = 60;
      const ctx = cnv.getContext('2d');
      ctx.drawImage(videoPlayer, 0, 0, cnv.width, cnv.height);
      thumbs.push(cnv.toDataURL());
    }

    timeline.innerHTML = '';
    thumbs.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      timeline.appendChild(img);
    });

    await new Promise(r => requestAnimationFrame(r));
    const rect = timeline.getBoundingClientRect();
    timelineWidth = rect.width || trimContainer.clientWidth;

    const initLen = Math.min(MAX_WINDOW, duration);
    trimStart = 0;
    trimEnd   = initLen;

    syncUIFromTimes();
    setupHandleDrag();
    setupWindowDrag();
  }

  function timeToX(t) {
    if (!duration || !timelineWidth) return 0;
    return (t / duration) * timelineWidth;
  }
  function xToTime(x) {
    if (!timelineWidth || !duration) return 0;
    return (x / timelineWidth) * duration;
  }

  function syncUIFromTimes() {
    const leftX  = timeToX(trimStart);
    const rightX = timeToX(trimEnd);

    leftHandle.style.left   = `${leftX}px`;
    rightHandle.style.right = `${timelineWidth - rightX}px`;

    shadeLeft.style.width   = `${leftX}px`;
    shadeRight.style.width  = `${timelineWidth - rightX}px`;

    windowDrag.style.left   = `${leftX}px`;
    windowDrag.style.width  = `${Math.max(0, rightX - leftX)}px`;

    trimStartEl.textContent = trimStart.toFixed(1);
    trimEndEl.textContent   = trimEnd.toFixed(1);
  }

  function clampWindow(start, end) {
    let s = Math.max(0, Math.min(start, duration));
    let e = Math.max(0, Math.min(end, duration));
    if (e < s) [s, e] = [e, s];

    let len = e - s;
    if (len < MIN_WINDOW) {
      e = Math.min(duration, s + MIN_WINDOW);
      s = e - MIN_WINDOW;
      len = MIN_WINDOW;
    }
    if (len > MAX_WINDOW) {
      e = s + MAX_WINDOW;
      if (e > duration) {
        e = duration;
        s = e - MAX_WINDOW;
      }
      len = MAX_WINDOW;
    }
    return { start: s, end: e };
  }

  function setupHandleDrag() {
    leftHandle.onpointerdown = (e) => {
      e.preventDefault();
      const startX = e.clientX;
      const origLeftX = timeToX(trimStart);

      const move = (ev) => {
        const dx = ev.clientX - startX;
        let newLeftX = origLeftX + dx;
        newLeftX = Math.max(0, Math.min(newLeftX, timeToX(trimEnd) - 1));
        let newStart = xToTime(newLeftX);
        let { start, end } = clampWindow(newStart, trimEnd);
        trimStart = start;
        trimEnd   = end;
        syncUIFromTimes();
      };

      const up = () => {
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
      };
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    };

    rightHandle.onpointerdown = (e) => {
      e.preventDefault();
      const startX = e.clientX;
      const origRightX = timeToX(trimEnd);

      const move = (ev) => {
        const dx = ev.clientX - startX;
        let newRightX = origRightX + dx;
        newRightX = Math.min(timelineWidth, Math.max(newRightX, timeToX(trimStart) + 1));
        let newEnd = xToTime(newRightX);
        let { start, end } = clampWindow(trimStart, newEnd);
        trimStart = start;
        trimEnd   = end;
        syncUIFromTimes();
      };

      const up = () => {
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
      };
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    };
  }

  function setupWindowDrag() {
    windowDrag.onpointerdown = (e) => {
      e.preventDefault();
      windowDrag.style.cursor = 'grabbing';

      const startX = e.clientX;
      const origStart = trimStart;
      const origEnd   = trimEnd;

      const move = (ev) => {
        const dx = ev.clientX - startX;
        const deltaTime = xToTime(dx) - xToTime(0);

        let newStart = origStart + deltaTime;
        let newEnd   = origEnd + deltaTime;

        if (newStart < 0) {
          newEnd -= newStart;
          newStart = 0;
        }
        if (newEnd > duration) {
          const over = newEnd - duration;
          newStart -= over;
          newEnd = duration;
          if (newStart < 0) newStart = 0;
        }

        const res = clampWindow(newStart, newEnd);
        trimStart = res.start;
        trimEnd   = res.end;
        syncUIFromTimes();
      };

      const up = () => {
        windowDrag.style.cursor = 'grab';
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
      };

      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    };
  }

  async function processVideoFrames() {
    const fps = Number(fpsInput.value) || 10;
    if (!selectedFile || !cropper || !fps) return;

    const startSec = trimStart;
    const endSec   = trimEnd;
    const span     = endSec - startSec;
    if (span <= 0) {
      alert('æ—¶é—´åŒºé—´ä¸åˆæ³•');
      return;
    }

    const cropData = cropper.getData(true); // x, y, width, heightï¼ˆåŸºäºåŸå§‹è§†é¢‘å°ºå¯¸ï¼‰

    const step = 1 / fps;
    const frameTimes = [];
    for (let t = startSec; t <= endSec + 1e-4; t += step) {
      frameTimes.push(Math.min(t, endSec));
    }

    setStatus({
      main: `å…± ${frameTimes.length} å¸§ï¼Œæ­£åœ¨æˆªå–â€¦`,
      sub: 'æ‰€æœ‰æ“ä½œéƒ½åœ¨æœ¬åœ°æµè§ˆå™¨æ‰§è¡Œã€‚',
      state: 'working',
      progress: 60
    });

    framesStrip.innerHTML = '';
    currentFrames = [];
    downloadZipBtn.disabled = true;

    await unlockVideo();

    const canvas = document.createElement('canvas');
    canvas.width  = Math.round(cropData.width);
    canvas.height = Math.round(cropData.height);
    const ctx = canvas.getContext('2d');

    for (let i = 0; i < frameTimes.length; i++) {
      const t = frameTimes[i];
      const pct = 60 + (i + 1) / frameTimes.length * 30;

      setStatus({
        main: `æ­£åœ¨æˆªå–å¸§ ${i+1} / ${frameTimes.length}`,
        sub: `æ—¶é—´ä½ç½®ï¼š${t.toFixed(2)}s`,
        state: 'working',
        progress: pct
      });

      await seekVideo(t);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(
        videoPlayer,
        cropData.x, cropData.y, cropData.width, cropData.height,
        0, 0, canvas.width, canvas.height
      );

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
      if (!blob) continue;
      currentFrames.push(blob);

      const imgUrl = URL.createObjectURL(blob);
      const div = document.createElement('div');
      div.className = 'thumb';
      const img = document.createElement('img');
      img.src = imgUrl;
      div.appendChild(img);

      const meta = document.createElement('div');
      meta.className = 'thumb-meta';
      const tag = document.createElement('span');
      tag.className = 'thumb-tag';
      tag.textContent = `#${i+1}`;
      const timeLabel = document.createElement('span');
      timeLabel.className = 'thumb-time';
      timeLabel.textContent = `${t.toFixed(2)}s`;

      meta.appendChild(tag);
      meta.appendChild(timeLabel);
      div.appendChild(meta);
      framesStrip.appendChild(div);
    }

    setStatus({
      main: `æˆªå–å®Œæˆï¼šå…± ${currentFrames.length} å¸§ã€‚`,
      sub: 'å¯ä»¥æ‰“åŒ…ä¸‹è½½ ZIPï¼Œæˆ–é‡æ–°è°ƒæ•´è£å‰ªåå†åˆ‡ä¸€è½®ã€‚',
      state: 'idle',
      progress: 95
    });

    if (currentFrames.length > 0) downloadZipBtn.disabled = false;
  }

  confirmBtn.addEventListener('click', async () => {
    if (!selectedFile || !cropper) {
      alert('è¯·å…ˆé€‰æ‹©è§†é¢‘å¹¶ç”Ÿæˆå‚è€ƒå¸§');
      return;
    }
    confirmBtn.disabled = true;
    downloadZipBtn.disabled = true;

    try {
      await processVideoFrames();
    } catch (e) {
      console.error(e);
      setStatus({
        main: 'åˆ‡å¸§å¤±è´¥ã€‚',
        sub: e.message || '',
        state: 'error',
        progress: 0
      });
    } finally {
      confirmBtn.disabled = false;
    }
  });

  downloadZipBtn.addEventListener('click', async () => {
    if (!currentFrames.length) return;

    downloadZipBtn.disabled = true;
    setStatus({
      main: 'æ­£åœ¨æ‰“åŒ… ZIPâ€¦',
      state: 'working',
      progress: 98
    });

    try {
      const zip = new JSZip();
      const folder = zip.folder('frames');
      for (let i = 0; i < currentFrames.length; i++) {
        const blob = currentFrames[i];
        const indexStr = String(i + 1).padStart(3, '0');
        folder.file(`frame-${indexStr}.jpg`, blob);
      }
      const zipBlob = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      const url = URL.createObjectURL(zipBlob);
      a.href = url;
      a.download = 'frames.zip';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      setStatus({
        main: 'ZIP æ‰“åŒ…å®Œæˆï¼Œå·²å¼€å§‹ä¸‹è½½ã€‚',
        sub: 'å¦‚éœ€å†æ¬¡åˆ‡å¸§ï¼Œå¯ä¿®æ”¹å‚æ•°åé‡æ–°æ‰§è¡Œã€‚',
        state: 'idle',
        progress: 100
      });
    } catch (e) {
      console.error(e);
      setStatus({
        main: 'æ‰“åŒ…å¤±è´¥ã€‚',
        sub: e.message || '',
        state: 'error',
        progress: 0
      });
    } finally {
      if (currentFrames.length) downloadZipBtn.disabled = false;
    }
  });

  // åˆå§‹åŒ–
  resetAll();
</script>

</body>
</html>
