<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>è§†é¢‘ 4:3 æˆªå›¾å·¥å…· Â· FramePicker</title>
  <!-- ç¦æ­¢æ•´é¡µç¼©æ”¾ï¼Œé¿å…ä¸€ç¢°å°±æ”¾å¤§ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

  <!-- JSZipï¼šå‰ç«¯æ‰“åŒ… ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #020617;
      --card-elevated: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-strong: rgba(56, 189, 248, 0.2);
      --accent-green: #22c55e;
      --accent-red: #f97373;
      --border-subtle: rgba(148, 163, 184, 0.4);
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-mute: #6b7280;
      --radius-xl: 18px;
      --radius-lg: 12px;
      --radius-pill: 999px;
      --shadow-soft: 0 22px 60px rgba(15, 23, 42, 0.55);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      display: flex;
      justify-content: center;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 40%, #000 100%);
      color: var(--text-main);
    }

    .app-shell {
      width: 100%;
      max-width: 1120px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(15,23,42,0.9));
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 12px 35px rgba(15,23,42,0.6);
      backdrop-filter: blur(14px);
    }

    .title-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-main {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top, rgba(148,163,184,0.2), rgba(15,23,42,0.9));
      color: #e5e7eb;
    }

    .title-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .chip {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-sub);
    }

    /* ä¸»å¡ç‰‡å¸ƒå±€ */
    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 14px;
    }

    @media (max-width: 880px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), #020617);
      border-radius: var(--radius-xl);
      padding: 14px 16px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: var(--shadow-soft);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .step-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .step-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .card-header-right {
      font-size: 11px;
      color: var(--text-mute);
      text-align: right;
    }

    /* ä¸Šä¼  & è§†é¢‘åŒºåŸŸ */

    #videoPlayer {
      width: 100%;
      max-width: 480px;
      display: none;
      border-radius: var(--radius-lg);
      margin-top: 8px;
      background:#000;
      border: 1px solid rgba(30,64,175,0.7);
      box-shadow: 0 10px 30px rgba(15,23,42,0.75);
    }

    .file-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }

    input[type="file"] {
      font-size: 13px;
      color: var(--text-main);
    }

    input[type="file"]::file-selector-button {
      border:none;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(31,41,55,0.9);
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
      border:1px solid rgba(148,163,184,0.6);
      margin-right: 10px;
    }

    #videoMeta {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    /* å‚è€ƒå¸§ + è£å‰ª + æ—¶é—´è½´ */

    .row-flex {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-top: 4px;
    }

    .preview-column {
      flex: 0 0 280px;
      max-width: 360px;
      min-width: 240px;
    }

    .controls-column {
      flex: 1;
      min-width: 230px;
    }

    .label-text {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 6px;
      margin-bottom: 4px;
    }

    #previewWrap {
      position:relative;
      width:100%;
      max-width:380px;
      overflow:hidden;
      border-radius: var(--radius-lg);
      background:#020617;
      border:1px solid rgba(148,163,184,0.4);
      touch-action:none;
      box-shadow: 0 12px 35px rgba(15,23,42,0.85);
    }

    #framePreview {
      width:100%;
      display:none;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    #cropBox {
      position:absolute;
      left:10px;
      right:10px;
      margin:0 auto;
      border:2px solid var(--accent);
      box-shadow:0 0 0 9999px rgba(0,0,0,0.55);
      border-radius:12px;
      pointer-events:auto;
      touch-action:none;
      background:transparent;
    }

    #cropBox::after{
      content:'4:3';
      position:absolute;
      right:6px;
      bottom:6px;
      font-size:10px;
      padding:2px 6px;
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
    }

    #cropSlider {
      width:100%;
      accent-color: var(--accent);
    }

    input[type="range"] {
      -webkit-appearance:none;
      appearance:none;
      height:4px;
      border-radius:999px;
      background: rgba(15,23,42,0.9);
      outline:none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance:none;
      appearance:none;
      width:15px;
      height:15px;
      border-radius:999px;
      background: var(--accent);
      box-shadow:0 0 0 2px rgba(15,23,42,0.9);
      cursor:pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width:15px;
      height:15px;
      border-radius:999px;
      background: var(--accent);
      cursor:pointer;
    }

    /* æ—¶é—´è½´ */

    #trimContainer {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 62px;
      margin-top: 6px;
      overflow: hidden;
      border-radius: 12px;
      background: radial-gradient(circle at top, #1e293b, #020617);
      border:1px solid rgba(30,64,175,0.7);
      box-shadow: 0 10px 30px rgba(15,23,42,0.8);
    }
    #timeline {
      height: 100%;
      display: flex;
    }
    #timeline img {
      height: 100%;
      width: auto;
      flex-shrink: 0;
      object-fit: cover;
      filter: saturate(1.1) contrast(1.05);
    }
    #trimOverlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }
    .handle {
      position: absolute;
      top: 0;
      width: 14px;
      height: 100%;
      background: rgba(15,23,42,0.05);
      border: 2px solid #f9fafb;
      border-radius: 10px;
      cursor: ew-resize;
      box-shadow:0 0 0 1px rgba(15,23,42,0.8), 0 0 8px rgba(15,23,42,0.9);
      pointer-events:auto;
      z-index:2;
    }
    .handle::before {
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:1px;
      height:22px;
      border-radius:999px;
      transform:translate(-50%,-50%);
      background:linear-gradient(to bottom, rgba(15,23,42,0.1), rgba(15,23,42,0.9), rgba(15,23,42,0.1));
    }

    #leftHandle { left: 0; }
    #rightHandle { right: 0; }

    .shade {
      position: absolute;
      top: 0;
      height: 100%;
      background: rgba(15,23,42,0.7);
      pointer-events: none;
      z-index:1;
    }
    #shadeLeft  { left: 0; width: 0; }
    #shadeRight { right: 0; width: 0; }

    #windowDragArea {
      position:absolute;
      top:0;
      height:100%;
      cursor:grab;
      z-index:1;
      pointer-events:auto;
    }

    .inline-meta {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }

    .pill-meta {
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.6);
      font-size:11px;
      color:var(--text-sub);
    }

    .button-row {
      display:flex;
      gap:8px;
      margin-top:8px;
      flex-wrap:wrap;
    }

    .btn {
      padding:7px 14px;
      border-radius:var(--radius-pill);
      border:none;
      font-size:13px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:transform 0.08s ease, box-shadow 0.08s ease, background 0.12s;
      white-space:nowrap;
    }
    .btn:disabled {
      opacity:0.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    .btn-primary {
      background:linear-gradient(135deg, #38bdf8, #2563eb);
      color:#f9fafb;
      box-shadow:0 12px 30px rgba(37,99,235,0.45);
      border:1px solid rgba(191,219,254,0.8);
    }
    .btn-primary:hover:not(:disabled) {
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(37,99,235,0.55);
    }
    .btn-secondary {
      background:rgba(15,23,42,0.95);
      color:var(--text-sub);
      border:1px solid rgba(148,163,184,0.7);
    }
    .btn-secondary:hover:not(:disabled) {
      background:rgba(15,23,42,1);
      transform:translateY(-1px);
      box-shadow:0 10px 26px rgba(15,23,42,0.85);
    }
    .btn-success {
      background:linear-gradient(135deg, #22c55e, #16a34a);
      color:#f9fafb;
      border:1px solid rgba(187,247,208,0.9);
      box-shadow:0 12px 30px rgba(34,197,94,0.55);
    }
    .btn-success:hover:not(:disabled) {
      transform:translateY(-1px);
      box-shadow:0 14px 36px rgba(34,197,94,0.7);
    }

    /* çŠ¶æ€æ¡ + è¿›åº¦æ¡ */

    .status-bar {
      margin-top:10px;
      padding:6px 9px;
      border-radius: var(--radius-lg);
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.45);
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:11px;
      color: var(--text-sub);
    }

    .status-line {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .status-dot {
      width:7px;
      height:7px;
      border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(56,189,248,0.18);
    }
    .status-dot.idle {
      background:#6b7280;
      box-shadow:none;
    }
    .status-dot.error {
      background:var(--accent-red);
      box-shadow:0 0 0 4px rgba(248,113,113,0.2);
    }
    .status-text-main {
      color:var(--text-main);
    }

    .progress-wrap {
      width:100%;
      height:4px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      overflow:hidden;
    }
    .progress-bar {
      width:0%;
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg, #38bdf8, #22c55e);
      transition:width 0.12s ease-out;
    }

    /* ç»“æœå±•ç¤º */

    #framesStrip {
      display:flex;
      gap:10px;
      overflow-x:auto;
      margin-top:10px;
      padding-bottom:4px;
    }
    #framesStrip::-webkit-scrollbar {
      height:6px;
    }
    #framesStrip::-webkit-scrollbar-track {
      background:rgba(15,23,42,0.9);
      border-radius:999px;
    }
    #framesStrip::-webkit-scrollbar-thumb {
      background:linear-gradient(90deg, #38bdf8, #22c55e);
      border-radius:999px;
    }

    .thumb {
      flex:0 0 auto;
      width:160px;
      background:radial-gradient(circle at top, #020617, #020617);
      border-radius:14px;
      padding:5px;
      box-shadow:0 10px 25px rgba(15,23,42,0.95);
      border:1px solid rgba(30,64,175,0.7);
      font-size:11px;
      color:var(--text-sub);
    }
    .thumb img {
      width:100%;
      border-radius:10px;
      display:block;
    }
    .thumb-meta {
      margin-top:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .thumb-tag {
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
    }
    .thumb-time {
      font-size:10px;
      color:var(--text-mute);
    }

    @media (max-width: 640px) {
      .card {
        padding:12px;
      }
      .header {
        flex-direction:column;
        align-items:flex-start;
      }
      .card-header {
        flex-direction:column;
        align-items:flex-start;
        gap:4px;
      }
    }
  </style>
</head>
<body>

<div class="app-shell">

  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <header class="header">
    <div class="title-group">
      <div class="title-main">
        FramePicker
        <span class="badge">4:3 Frame Cutter Â· Pure Frontend</span>
      </div>
      <div class="title-sub">
        å®¢æˆ·ä¸Šä¼ è§†é¢‘ â†’ é€‰ 4:3 åŒºåŸŸå’Œ 0â€“8 ç§’æ—¶é—´æ®µ â†’ æµè§ˆå™¨æœ¬åœ°é€å¸§åˆ‡å›¾ â†’ é¢„è§ˆ & ZIP æ‰“åŒ…ä¸‹è½½ã€‚
      </div>
    </div>
    <div class="chip-group">
      <span class="chip">æœ¬åœ°å¤„ç† Â· ä¸ä¸Šä¼ æœåŠ¡å™¨</span>
      <span class="chip">æ”¯æŒæ‰‹æœº / ç”µè„‘</span>
      <span class="chip">æœ€å¤š 8 ç§’ç²¾åˆ‡</span>
    </div>
  </header>

  <main class="main-grid">

    <!-- å·¦ä¾§ï¼šä¸Šä¼  + å‚è€ƒå¸§ + è£å‰ª + æ—¶é—´è½´ -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="step-label">
            <span class="step-dot">1</span>
            SELECT & PREPARE
          </div>
          <div class="card-title">é€‰æ‹©è§†é¢‘ã€ç”Ÿæˆå‚è€ƒå¸§ & æ—¶é—´åŒºé—´</div>
          <div class="card-sub">ç«–å±è§†é¢‘æ•ˆæœæœ€å¥½ï¼Œå·¥å…·ä¼šåœ¨æœ¬åœ°æå– 4:3 æ¨ªå‘åŒºåŸŸã€‚</div>
        </div>
        <div class="card-header-right">
          å»ºè®®å•æ®µæ—¶é•¿ â‰¤ 8 ç§’<br/>
          ç«–å± Live / å½•åƒçš†å¯
        </div>
      </div>

      <!-- ä¸Šä¼  + è§†é¢‘é¢„è§ˆ -->
      <div class="file-row">
        <input id="videoInput" type="file" accept="video/*">
        <button id="resetBtn" class="btn btn-secondary" style="padding-inline:10px;font-size:12px;">
          é‡ç½®
        </button>
      </div>
      <div id="videoMeta"></div>
      <video id="videoPlayer" controls playsinline webkit-playsinline muted></video>

      <!-- å‚è€ƒå¸§ + è£å‰ª + æ—¶é—´è½´ -->
      <div class="row-flex" style="margin-top:10px;">
        <div class="preview-column">
          <div class="label-text">å‚è€ƒå¸§é¢„è§ˆ & 4:3 è£å‰ªåŒºåŸŸ</div>
          <div id="previewWrap">
            <img id="framePreview" alt="å‚è€ƒå¸§"/>
            <div id="cropBox" style="display:none;"></div>
          </div>
        </div>

        <div class="controls-column">
          <div class="label-text">æ­¥éª¤ A Â· ç”Ÿæˆå‚è€ƒå¸§ & æ—¶é—´è½´</div>
          <button id="initBtn" class="btn btn-primary" disabled>
            <span>âš™ï¸ ç”Ÿæˆå‚è€ƒå¸§ & æ—¶é—´è½´</span>
          </button>
          <div style="font-size:11px;color:var(--text-mute);margin-top:3px;">
            é€‰å®Œè§†é¢‘åï¼Œç›´æ¥ç‚¹å‡»å³å¯ï¼šå·¥å…·ä¼šç”¨ä¸­é—´ä¸€å¸§ä½œä¸ºå‚è€ƒï¼Œå¹¶ç”Ÿæˆæ•´æ®µçš„æ—¶é—´è½´ç¼©ç•¥å›¾ã€‚
          </div>

          <div class="label-text" style="margin-top:10px;">4:3 åŒºåŸŸä¸Šä¸‹ä½ç½®</div>
          <input id="cropSlider" type="range" min="0" max="1000" value="500">
          <div style="font-size:11px;color:var(--text-mute);margin-top:2px;">
            æ‹–åŠ¨æ»‘æ¡æˆ–ç›´æ¥æ‹–åŠ¨ç»¿è‰²æ¡†ä¸Šä¸‹ç§»åŠ¨ï¼Œæ¡†å†…å³ä¸ºæœ€ç»ˆåˆ‡å‡ºçš„ 4:3 åŒºåŸŸã€‚
          </div>

          <div class="label-text" style="margin-top:10px;">æ­¥éª¤ B Â· æ—¶é—´åŒºé—´é€‰æ‹©ï¼ˆæœ€å¤š 8 ç§’ï¼‰</div>
          <div id="trimContainer">
            <div id="timeline"></div>
            <div id="trimOverlay">
              <div id="shadeLeft" class="shade"></div>
              <div id="shadeRight" class="shade"></div>
              <div id="leftHandle" class="handle"></div>
              <div id="rightHandle" class="handle"></div>
              <div id="windowDragArea"></div>
            </div>
          </div>

          <div class="inline-meta">
            <span class="pill-meta">
              åŒºé—´ï¼š
              <span id="trimStart">0.0</span>s â€“ <span id="trimEnd">0.0</span>s
            </span>
            <span class="pill-meta">
              å¸§ç‡ï¼š
              <input id="fpsInput" type="number" value="10" min="1" max="30"
                     style="width:52px;padding:2px 6px;border-radius:999px;border:1px solid rgba(148,163,184,0.7);background:rgba(15,23,42,0.9);color:var(--text-main);font-size:11px;">
              fps
            </span>
          </div>

          <div class="button-row">
            <button id="confirmBtn" class="btn btn-primary" disabled>
              ğŸš€ å¼€å§‹åˆ‡å¸§ï¼ˆåœ¨æµè§ˆå™¨æœ¬åœ°æ‰§è¡Œï¼‰
            </button>
            <button id="downloadZipBtn" class="btn btn-success" disabled>
              ğŸ“¦ æ‰“åŒ…ä¸‹è½½å…¨éƒ¨å›¾ç‰‡
            </button>
          </div>

          <div class="status-bar">
            <div class="status-line">
              <div id="statusDot" class="status-dot idle"></div>
              <div>
                <span id="statusTextMain" class="status-text-main">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ã€‚</span>
                <span id="statusTextSub" style="margin-left:6px;"></span>
              </div>
            </div>
            <div class="progress-wrap">
              <div id="progressBar" class="progress-bar"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- å³ä¾§ï¼šç»“æœé¢„è§ˆ -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="step-label">
            <span class="step-dot">2</span>
            REVIEW & EXPORT
          </div>
          <div class="card-title">é¢„è§ˆåˆ‡å‡ºçš„å›¾ç‰‡ & å¯¼å‡º ZIP</div>
          <div class="card-sub">æ‰€æœ‰æˆªå›¾å‡ä¸ºä½ é€‰å®šçš„ 4:3 åŒºåŸŸï¼ŒæŒ‰æ—¶é—´é¡ºåºæ¨ªå‘æ’åˆ—ã€‚</div>
        </div>
        <div class="card-header-right">
          æ”¯æŒæœ¬åœ°æµè§ˆ & ä¸‹è½½<br/>
          å¯é‡å¤é€‰æ‹©æ–°è§†é¢‘
        </div>
      </div>

      <div style="font-size:12px;color:var(--text-mute);">
        æ¨ªå‘æ»‘åŠ¨å¯æµè§ˆå…¨éƒ¨æˆªå›¾ï¼›å¦‚éœ€é‡æ–°é€‰æ‹©åŒºåŸŸæˆ–æ—¶é—´æ®µï¼Œç›´æ¥å›åˆ°å·¦ä¾§è°ƒæ•´åå†æ¬¡åˆ‡å¸§å³å¯ã€‚
      </div>

      <div id="framesStrip"></div>
    </section>

  </main>
</div>

<script>
  const videoInput   = document.getElementById('videoInput');
  const videoPlayer  = document.getElementById('videoPlayer');
  const initBtn      = document.getElementById('initBtn');
  const resetBtn     = document.getElementById('resetBtn');
  const framePreview = document.getElementById('framePreview');
  const previewWrap  = document.getElementById('previewWrap');
  const cropBox      = document.getElementById('cropBox');
  const cropSlider   = document.getElementById('cropSlider');
  const fpsInput     = document.getElementById('fpsInput');
  const confirmBtn   = document.getElementById('confirmBtn');
  const downloadZipBtn = document.getElementById('downloadZipBtn');
  const statusDot    = document.getElementById('statusDot');
  const statusTextMain = document.getElementById('statusTextMain');
  const statusTextSub  = document.getElementById('statusTextSub');
  const progressBar  = document.getElementById('progressBar');
  const videoMeta    = document.getElementById('videoMeta');
  const framesStrip  = document.getElementById('framesStrip');

  // æ—¶é—´è½´ç›¸å…³
  const trimContainer = document.getElementById('trimContainer');
  const timeline      = document.getElementById('timeline');
  const leftHandle    = document.getElementById('leftHandle');
  const rightHandle   = document.getElementById('rightHandle');
  const shadeLeft     = document.getElementById('shadeLeft');
  const shadeRight    = document.getElementById('shadeRight');
  const windowDrag    = document.getElementById('windowDragArea');
  const trimStartEl   = document.getElementById('trimStart');
  const trimEndEl     = document.getElementById('trimEnd');

  let selectedFile = null;
  let videoUrl = null;

  let duration = 0;
  let trimStart = 0;
  let trimEnd = 0;
  let timelineWidth = 0;

  const MAX_WINDOW = 8;
  const MIN_WINDOW = 0.5;

  let currentFrames = [];

  // è£å‰ªç›¸å…³ï¼ˆè§†é¢‘åæ ‡ï¼‰
  let videoW = 0;
  let videoH = 0;
  let cropTopVideo = 0;
  let cropHeightVideo = 0;
  let cropMaxTopVideo = 0;

  const isIOS = /iP(hone|od|ad)/.test(navigator.platform)
        || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

  function setStatus({main, sub = '', state = 'idle', progress = 0}) {
    statusTextMain.textContent = main;
    statusTextSub.textContent = sub;
    progressBar.style.width = `${Math.max(0, Math.min(100, progress))}%`;

    statusDot.classList.remove('idle', 'error');
    if (state === 'working') {
      statusDot.classList.remove('idle', 'error');
    } else if (state === 'error') {
      statusDot.classList.add('error');
    } else {
      statusDot.classList.add('idle');
    }
  }

  async function unlockVideo() {
    if (!isIOS) return;
    try {
      await videoPlayer.play();
      videoPlayer.pause();
    } catch (e) {
      console.log('unlock error', e);
    }
  }

  // é‡ç½®
  function resetAll() {
    selectedFile = null;
    videoW = 0;
    videoH = 0;
    videoInput.value = '';
    confirmBtn.disabled = true;
    downloadZipBtn.disabled = true;
    initBtn.disabled = true;
    framesStrip.innerHTML = '';
    currentFrames = [];
    videoMeta.textContent = '';
    framePreview.style.display = 'none';
    cropBox.style.display = 'none';
    cropSlider.value = 500;
    timeline.innerHTML = '';
    trimStartEl.textContent = '0.0';
    trimEndEl.textContent = '0.0';
    progressBar.style.width = '0%';
    statusDot.classList.add('idle');
    setStatus({
      main: 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ã€‚',
      sub: 'æ”¯æŒæ‰‹æœºç›¸å†Œè§†é¢‘ï¼Œæœ¬åœ°å¤„ç†ä¸ä¸Šä¼ æœåŠ¡å™¨ã€‚',
      state: 'idle',
      progress: 0
    });
    if (videoUrl) {
      URL.revokeObjectURL(videoUrl);
      videoUrl = null;
    }
    videoPlayer.src = '';
    videoPlayer.style.display = 'none';
  }

  resetBtn.addEventListener('click', resetAll);

  // é€‰æ‹©è§†é¢‘
  videoInput.addEventListener('change', () => {
    const file = videoInput.files && videoInput.files[0];
    if (!file) {
      resetAll();
      return;
    }

    selectedFile = file;
    confirmBtn.disabled = true;
    downloadZipBtn.disabled = true;
    initBtn.disabled = false;
    framesStrip.innerHTML = '';
    currentFrames = [];
    framePreview.style.display = 'none';
    cropBox.style.display = 'none';
    cropSlider.value = 500;
    progressBar.style.width = '0%';

    setStatus({
      main: 'å·²é€‰æ‹©è§†é¢‘æ–‡ä»¶ã€‚',
      sub: 'ç‚¹å‡»ã€Œç”Ÿæˆå‚è€ƒå¸§ & æ—¶é—´è½´ã€å¼€å§‹å‡†å¤‡ã€‚',
      state: 'idle',
      progress: 5
    });

    if (videoUrl) URL.revokeObjectURL(videoUrl);
    videoUrl = URL.createObjectURL(file);

    videoPlayer.src = videoUrl;
    videoPlayer.style.display = 'block';

    videoPlayer.onloadedmetadata = () => {
      duration = videoPlayer.duration;
      videoW = videoPlayer.videoWidth;
      videoH = videoPlayer.videoHeight;
      videoMeta.textContent = `æ—¶é•¿ï¼š${duration.toFixed(1)} ç§’ Â· åˆ†è¾¨ç‡ï¼š${videoW} Ã— ${videoH}`;
    };
  });

  // ç”Ÿæˆå‚è€ƒå¸§ + æ—¶é—´è½´
  initBtn.addEventListener('click', async () => {
    if (!selectedFile) {
      alert('è¯·å…ˆé€‰æ‹©è§†é¢‘');
      return;
    }
    initBtn.disabled = true;
    confirmBtn.disabled = true;
    downloadZipBtn.disabled = true;

    setStatus({
      main: 'æ­£åœ¨ç”Ÿæˆå‚è€ƒå¸§å’Œæ—¶é—´è½´â€¦',
      sub: 'å¤§æ–‡ä»¶å¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œè¯·ç¨å€™ã€‚',
      state: 'working',
      progress: 20
    });

    try {
      await unlockVideo();
      await setupPreviewFrame();
      setStatus({
        main: 'å‚è€ƒå¸§å·²ç”Ÿæˆï¼Œæ­£åœ¨æ„å»ºæ—¶é—´è½´ç¼©ç•¥å›¾â€¦',
        sub: '',
        state: 'working',
        progress: 35
      });
      await initTimelineFromVideo();

      confirmBtn.disabled = false;
      setStatus({
        main: 'å‡†å¤‡å°±ç»ªã€‚',
        sub: 'è°ƒæ•´ç»¿è‰² 4:3 åŒºåŸŸå’Œæ—¶é—´åŒºé—´åï¼Œç‚¹å‡»ã€Œå¼€å§‹åˆ‡å¸§ã€ã€‚',
        state: 'idle',
        progress: 45
      });
    } catch (e) {
      console.error(e);
      setStatus({
        main: 'ç”Ÿæˆå‚è€ƒå¸§å¤±è´¥ã€‚',
        sub: e.message || '',
        state: 'error',
        progress: 0
      });
      initBtn.disabled = false;
    }
  });

  // å–ä¸­é—´ä¸€å¸§ä½œä¸ºå‚è€ƒå¸§ï¼Œå¹¶åˆå§‹åŒ–è£å‰ªå‚æ•°
  async function setupPreviewFrame() {
    const captureTime = duration / 2;
    await seekVideo(captureTime);

    const canvas = document.createElement('canvas');
    canvas.width = videoW;
    canvas.height = videoH;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);

    framePreview.src = canvas.toDataURL('image/jpeg', 0.9);
    framePreview.style.display = 'block';

    // ä»¥è§†é¢‘å®½åº¦ä¸ºåŸºå‡†ï¼Œè£å‰ªé«˜åº¦ = å®½ * 3/4ï¼ˆ4:3ï¼‰
    cropHeightVideo = videoW * 3 / 4;
    cropMaxTopVideo = Math.max(0, videoH - cropHeightVideo);
    cropTopVideo = cropMaxTopVideo / 2;  // é»˜è®¤å±…ä¸­

    cropSlider.value = 500;
    applyCropUI();
  }

  function seekVideo(time) {
    return new Promise(resolve => {
      const handler = () => {
        videoPlayer.removeEventListener('seeked', handler);
        resolve();
      };
      videoPlayer.addEventListener('seeked', handler);
      videoPlayer.currentTime = time;
    });
  }

  // å°†è§†é¢‘åæ ‡çš„è£å‰ªåŒºåŸŸæ˜ å°„åˆ° UI ä¸Š
  function applyCropUI() {
    const displayW = framePreview.clientWidth;
    if (!displayW || !videoW) return;

    const scale = displayW / videoW;
    const displayH = videoH * scale;

    const dispCropH = cropHeightVideo * scale;
    const dispCropTop = cropTopVideo * scale;

    previewWrap.style.height = displayH + 'px';
    cropBox.style.display = 'block';
    cropBox.style.height = dispCropH + 'px';
    // å·¦å³ç•™ä¸€ç‚¹å†…è¾¹è·ï¼ˆé€šè¿‡ CSS çš„ left/right å·²ç»ç•™ 10pxï¼‰
    cropBox.style.top = dispCropTop + 'px';
  }

  cropSlider.addEventListener('input', () => {
    if (!videoH) return;
    const ratio = Number(cropSlider.value) / 1000;
    cropTopVideo = cropMaxTopVideo * ratio;
    applyCropUI();
  });

  // æ‰‹æŒ‡æ‹–åŠ¨è£å‰ªæ¡†ä¸Šä¸‹ç§»åŠ¨
  (function setupCropDrag(){
    let dragging = false;
    let startY = 0;
    let startTopVideo = 0;

    const pointerDown = (e) => {
      e.preventDefault();
      dragging = true;
      startY = e.clientY || (e.touches && e.touches[0].clientY);
      startTopVideo = cropTopVideo;
      cropBox.setPointerCapture && cropBox.setPointerCapture(e.pointerId || 1);
    };
    const pointerMove = (e) => {
      if (!dragging) return;
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      if (clientY == null) return;
      e.preventDefault();

      const displayW = framePreview.clientWidth;
      if (!displayW || !videoW) return;
      const scale = displayW / videoW;

      const dyPx = clientY - startY;
      const dyVideo = dyPx / scale;

      let newTop = startTopVideo + dyVideo;
      newTop = Math.max(0, Math.min(cropMaxTopVideo, newTop));

      cropTopVideo = newTop;
      applyCropUI();

      const ratio = cropMaxTopVideo ? (cropTopVideo / cropMaxTopVideo) : 0;
      cropSlider.value = Math.round(ratio * 1000);
    };
    const pointerUp = (e) => {
      dragging = false;
      cropBox.releasePointerCapture && cropBox.releasePointerCapture(e.pointerId || 1);
    };

    cropBox.addEventListener('pointerdown', pointerDown);
    cropBox.addEventListener('pointermove', pointerMove);
    cropBox.addEventListener('pointerup', pointerUp);
    cropBox.addEventListener('pointercancel', pointerUp);

    cropBox.addEventListener('touchstart', pointerDown, {passive:false});
    cropBox.addEventListener('touchmove', pointerMove, {passive:false});
    cropBox.addEventListener('touchend', pointerUp);
  })();

  // æ—¶é—´è½´ï¼šç”Ÿæˆç¼©ç•¥å›¾å¹¶åˆå§‹åŒ–é€‰åŒº
  async function initTimelineFromVideo() {
    const thumbs = [];
    const framesCount = Math.min(16, Math.max(6, Math.round(duration * 1.5)));

    for (let i = 0; i < framesCount; i++) {
      const t = duration * (i + 0.5) / framesCount;
      await seekVideo(t);

      const cnv = document.createElement('canvas');
      cnv.width = 60;
      cnv.height = 60;
      const ctx = cnv.getContext('2d');
      ctx.drawImage(videoPlayer, 0, 0, cnv.width, cnv.height);
      thumbs.push(cnv.toDataURL());
    }

    timeline.innerHTML = '';
    thumbs.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      timeline.appendChild(img);
    });

    await new Promise(r => requestAnimationFrame(r));
    const rect = timeline.getBoundingClientRect();
    timelineWidth = rect.width || trimContainer.clientWidth;

    const initLen = Math.min(MAX_WINDOW, duration);
    trimStart = 0;
    trimEnd   = initLen;

    syncUIFromTimes();
    setupHandleDrag();
    setupWindowDrag();
  }

  function timeToX(t) {
    if (!duration || !timelineWidth) return 0;
    return (t / duration) * timelineWidth;
  }
  function xToTime(x) {
    if (!timelineWidth || !duration) return 0;
    return (x / timelineWidth) * duration;
  }

  function syncUIFromTimes() {
    const leftX  = timeToX(trimStart);
    const rightX = timeToX(trimEnd);

    leftHandle.style.left   = `${leftX}px`;
    rightHandle.style.right = `${timelineWidth - rightX}px`;

    shadeLeft.style.width   = `${leftX}px`;
    shadeRight.style.width  = `${timelineWidth - rightX}px`;

    windowDrag.style.left   = `${leftX}px`;
    windowDrag.style.width  = `${Math.max(0, rightX - leftX)}px`;

    trimStartEl.textContent = trimStart.toFixed(1);
    trimEndEl.textContent   = trimEnd.toFixed(1);
  }

  function clampWindow(start, end) {
    let s = Math.max(0, Math.min(start, duration));
    let e = Math.max(0, Math.min(end, duration));
    if (e < s) [s, e] = [e, s];

    let len = e - s;
    if (len < MIN_WINDOW) {
      e = Math.min(duration, s + MIN_WINDOW);
      s = e - MIN_WINDOW;
      len = MIN_WINDOW;
    }
    if (len > MAX_WINDOW) {
      e = s + MAX_WINDOW;
      if (e > duration) {
        e = duration;
        s = e - MAX_WINDOW;
      }
      len = MAX_WINDOW;
    }
    return { start: s, end: e };
  }

  function setupHandleDrag() {
    leftHandle.onpointerdown = (e) => {
      e.preventDefault();
      const startX = e.clientX;
      const origLeftX = timeToX(trimStart);

      const move = (ev) => {
        const dx = ev.clientX - startX;
        let newLeftX = origLeftX + dx;
        newLeftX = Math.max(0, Math.min(newLeftX, timeToX(trimEnd) - 1));

        let newStart = xToTime(newLeftX);
        let { start, end } = clampWindow(newStart, trimEnd);
        trimStart = start;
        trimEnd   = end;

        syncUIFromTimes();
      };

      const up = () => {
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
      };

      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    };

    rightHandle.onpointerdown = (e) => {
      e.preventDefault();
      const startX = e.clientX;
      const origRightX = timeToX(trimEnd);

      const move = (ev) => {
        const dx = ev.clientX - startX;
        let newRightX = origRightX + dx;
        newRightX = Math.min(timelineWidth, Math.max(newRightX, timeToX(trimStart) + 1));

        let newEnd = xToTime(newRightX);
        let { start, end } = clampWindow(trimStart, newEnd);
        trimStart = start;
        trimEnd   = end;

        syncUIFromTimes();
      };

      const up = () => {
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
      };

      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    };
  }

  function setupWindowDrag() {
    windowDrag.onpointerdown = (e) => {
      e.preventDefault();
      windowDrag.style.cursor = 'grabbing';

      const startX = e.clientX;
      const origStart = trimStart;
      const origEnd   = trimEnd;

      const move = (ev) => {
        const dx = ev.clientX - startX;
        const deltaTime = xToTime(dx) - xToTime(0);

        let newStart = origStart + deltaTime;
        let newEnd   = origEnd + deltaTime;

        if (newStart < 0) {
          newEnd -= newStart;
          newStart = 0;
        }
        if (newEnd > duration) {
          const over = newEnd - duration;
          newStart -= over;
          newEnd = duration;
          if (newStart < 0) newStart = 0;
        }

        const res = clampWindow(newStart, newEnd);
        trimStart = res.start;
        trimEnd   = res.end;

        syncUIFromTimes();
      };

      const up = () => {
        windowDrag.style.cursor = 'grab';
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
      };

      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
    };
  }

  // çº¯å‰ç«¯åˆ‡å¸§
  async function processVideoFrames() {
    const fps = Number(fpsInput.value) || 10;
    if (!selectedFile || !videoW || !videoH) return;

    const startSec = trimStart;
    const endSec   = trimEnd;
    const span     = endSec - startSec;
    if (span <= 0) {
      alert('æ—¶é—´åŒºé—´ä¸åˆæ³•');
      return;
    }

    const step = 1 / fps;
    const frameTimes = [];
    for (let t = startSec; t <= endSec + 1e-4; t += step) {
      frameTimes.push(Math.min(t, endSec));
    }

    setStatus({
      main: `å…± ${frameTimes.length} å¸§ï¼Œæ­£åœ¨æˆªå–â€¦`,
      sub: 'æ‰€æœ‰æ“ä½œéƒ½åœ¨æœ¬åœ°æµè§ˆå™¨å®Œæˆï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨ã€‚',
      state: 'working',
      progress: 55
    });
    framesStrip.innerHTML = '';
    currentFrames = [];
    downloadZipBtn.disabled = true;

    await unlockVideo();

    const canvas = document.createElement('canvas');
    canvas.width  = videoW;                 // è¾“å‡ºå®½åº¦ = è§†é¢‘å®½åº¦
    canvas.height = cropHeightVideo;        // è¾“å‡ºé«˜åº¦ = 4:3ï¼Œå¯¹åº” videoW * 3/4
    const ctx = canvas.getContext('2d');

    for (let i = 0; i < frameTimes.length; i++) {
      const t = frameTimes[i];
      const pct = 55 + (i + 1) / frameTimes.length * 35; // 55% -> 90%

      setStatus({
        main: `æ­£åœ¨æˆªå–å¸§ ${i+1} / ${frameTimes.length}`,
        sub: `æ—¶é—´ä½ç½®ï¼š${t.toFixed(2)}s`,
        state: 'working',
        progress: pct
      });

      await seekVideo(t);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(
        videoPlayer,
        0, cropTopVideo, videoW, cropHeightVideo,
        0, 0, canvas.width, canvas.height
      );

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
      if (!blob) continue;
      currentFrames.push(blob);

      const imgUrl = URL.createObjectURL(blob);
      const div = document.createElement('div');
      div.className = 'thumb';
      const img = document.createElement('img');
      img.src = imgUrl;
      div.appendChild(img);

      const meta = document.createElement('div');
      meta.className = 'thumb-meta';

      const tag = document.createElement('span');
      tag.className = 'thumb-tag';
      tag.textContent = `#${i+1}`;
      meta.appendChild(tag);

      const timeLabel = document.createElement('span');
      timeLabel.className = 'thumb-time';
      timeLabel.textContent = `${t.toFixed(2)}s`;
      meta.appendChild(timeLabel);

      div.appendChild(meta);
      framesStrip.appendChild(div);
    }

    setStatus({
      main: `æˆªå–å®Œæˆï¼šå…± ${currentFrames.length} å¸§ã€‚`,
      sub: 'å¯ä»¥æ‰“åŒ…ä¸‹è½½ ZIPï¼Œæˆ–è°ƒæ•´å‚æ•°é‡æ–°åˆ‡å¸§ã€‚',
      state: 'idle',
      progress: 95
    });
    if (currentFrames.length > 0) {
      downloadZipBtn.disabled = false;
    }
  }

  confirmBtn.addEventListener('click', async () => {
    if (!selectedFile || !videoW) {
      alert('è¯·å…ˆé€‰æ‹©è§†é¢‘å¹¶ç”Ÿæˆå‚è€ƒå¸§');
      return;
    }
    confirmBtn.disabled = true;
    downloadZipBtn.disabled = true;

    try {
      await processVideoFrames();
    } catch (e) {
      console.error(e);
      setStatus({
        main: 'åˆ‡å¸§å¤±è´¥ã€‚',
        sub: e.message || '',
        state: 'error',
        progress: 0
      });
    } finally {
      confirmBtn.disabled = false;
    }
  });

  downloadZipBtn.addEventListener('click', async () => {
    if (!currentFrames.length) return;

    downloadZipBtn.disabled = true;
    setStatus({
      main: 'æ­£åœ¨æ‰“åŒ… ZIPâ€¦',
      sub: '',
      state: 'working',
      progress: 95
    });

    try {
      const zip = new JSZip();
      const folder = zip.folder('frames');

      for (let i = 0; i < currentFrames.length; i++) {
        const blob = currentFrames[i];
        const indexStr = String(i + 1).padStart(3, '0');
        folder.file(`frame-${indexStr}.jpg`, blob);
      }

      const zipBlob = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      const url = URL.createObjectURL(zipBlob);
      a.href = url;
      a.download = 'frames.zip';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      setStatus({
        main: 'ZIP æ‰“åŒ…å®Œæˆï¼Œå·²å¼€å§‹ä¸‹è½½ã€‚',
        sub: 'å¦‚éœ€å†æ¬¡åˆ‡å¸§ï¼Œå¯è°ƒæ•´å‚æ•°é‡æ–°æ‰§è¡Œã€‚',
        state: 'idle',
        progress: 100
      });
    } catch (e) {
      console.error(e);
      setStatus({
        main: 'æ‰“åŒ…å¤±è´¥ã€‚',
        sub: e.message || '',
        state: 'error',
        progress: 0
      });
    } finally {
      if (currentFrames.length) {
        downloadZipBtn.disabled = false;
      }
    }
  });

  // åˆå§‹åŒ–çŠ¶æ€
  resetAll();
</script>

</body>
</html>
